name: CI

on:
  push:
    branches:
      - branch-*
  pull_request:
    branches:
      - branch-*

jobs:
  test:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        modules:
          - ":hive-vector-code-gen,:hive-shims-common,:hive-shims-0.23,:hive-shims-scheduler,:hive-shims,:hive-common,:hive-service-rpc,:hive-serde"
          - ":hive-metastore"
          - ":hive-llap-common,:hive-llap-client,:hive-llap-tez,:hive-llap-server,:hive-service,:hive-jdbc,:hive-beeline,:hive-cli"
          - ":hive-exec"
          - ":hive-contrib,:hive-jdbc-handler"
          - ":hive-hcatalog,:hive-hcatalog-core,:hive-hcatalog-pig-adapter,:hive-hcatalog-server-extensions,:hive-webhcat-java-client"
          - ":hive-webhcat,:hive-hcatalog-streaming,:hive-hplsql,:hive-llap-ext-client,:hive-shims-aggregator,:hive-testutils,:hive-packaging"
          - ":hive-it,:hive-it-util,:hive-it-custom-serde,:hive-it-custom-udfs,:udf-classloader-util,:udf-classloader-udf1,:udf-classloader-udf2,:udf-vectorized-badexample"
          - ":hive-it-unit"
          - ":hive-it-unit-hadoop2"
          - ":hive-blobstore,:hive-it-test-serde,:hive-it-qfile,:hive-jmh,:hive-it-minikdc"
    steps:
    - uses: actions/checkout@v3
    - name: Setup JDK 8
      uses: actions/setup-java@v4
      with:
        distribution: zulu
        java-version: 8
        cache: maven
        check-latest: false
    - name: Build and Test with Maven
      run: |
        export HADOOP_HEAPSIZE=512m
        export MAVEN_OPTS="-Xmx768m -Djava.awt.headless=true"
        export MAVEN_ARGS="-B"
        mvn clean install -Pitests,dist -DskipTests
        mvn -Pitests \
            org.apache.maven.plugins:maven-antrun-plugin:run@define-classpath \
            org.apache.maven.plugins:maven-antrun-plugin:run@setup-test-dirs \
            org.apache.maven.plugins:maven-antrun-plugin:run@setup-metastore-scripts \
            org.apache.maven.plugins:maven-surefire-plugin:test \
            -Dsurefire.excludesFile=$PWD/.github/large-memory-tests.txt \
            -pl "${{ matrix.modules }}"
    - name: Upload test log
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: unit-test-log
        path: |
          **/*.log
